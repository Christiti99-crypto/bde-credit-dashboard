<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador BDD - Banco de Desarrollo del Ecuador</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .upload-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .upload-container {
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }

        .file-input {
            display: none;
        }

        .file-input-label {
            display: inline-block;
            padding: 12px 24px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .process-btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .process-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .process-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            padding: 30px;
            display: none;
        }

        .section-title {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            padding: 15px 25px;
            margin: 25px 0 15px 0;
            border-radius: 8px;
            font-size: 1.3rem;
            font-weight: 500;
        }

        .table-container {
            overflow-x: auto;
            margin-bottom: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: 500;
            font-size: 0.9rem;
        }

        td {
            padding: 10px 8px;
            text-align: right;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.85rem;
        }

        td:first-child {
            text-align: left;
            font-weight: 500;
            background: #f8f9fa;
            min-width: 300px;
        }

        tr:hover {
            background: #f1f3f4;
        }

        .cobertura-row { background: #fcf3cf !important; }
        .productivo-row { background: #ebf5fb !important; }
        .inv-publica-row { background: #e8f8f5 !important; }
        .indicadores-prod-row { background: #fef9e7 !important; }
        .indicadores-inv-row { background: #f4ecf7 !important; }
        .provisiones-row { background: #f8f9fa !important; }

        .export-section {
            padding: 20px 30px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            text-align: center;
        }

        .export-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .info-panel {
            background: #e8f4f8;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }

        .error-panel {
            background: #fdf2f2;
            border-left: 4px solid #e74c3c;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .upload-container {
                flex-direction: column;
            }
            
            th, td {
                padding: 8px 4px;
                font-size: 0.8rem;
            }
            
            td:first-child {
                min-width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Analizador BDD</h1>
            <p>Banco de Desarrollo del Ecuador - An√°lisis Trimestral de Cartera</p>
        </div>

        <div class="upload-section">
            <div class="upload-container">
                <div class="file-input-wrapper">
                    <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls">
                    <label for="fileInput" class="file-input-label">
                        üìÅ Seleccionar Archivo Excel
                    </label>
                </div>
                
                <button id="loadDefault" class="process-btn">
                    üîÑ Cargar Datos por Defecto
                </button>
                
                <button id="processBtn" class="process-btn" disabled>
                    ‚ö° Procesar Datos
                </button>
            </div>
            
            <div class="info-panel">
                <strong>üìã Instrucciones:</strong>
                <br>‚Ä¢ Sube un archivo Excel actualizado o usa los datos por defecto del repositorio
                <br>‚Ä¢ El sistema procesar√° autom√°ticamente solo las fechas trimestrales que ya han ocurrido
                <br>‚Ä¢ Los c√°lculos incluyen cartera productiva, inversi√≥n p√∫blica, coberturas y provisiones
                <br>‚Ä¢ Las fechas futuras no se mostrar√°n para evitar confusi√≥n
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Procesando datos... Por favor espera.</p>
        </div>

        <div class="results" id="results">
            <div class="section-title">üìä COBERTURAS</div>
            <div class="table-container">
                <table id="coberturasTable"></table>
            </div>

            <div class="section-title">üí∞ CARTERA PRODUCTIVO</div>
            <div class="table-container">
                <table id="productivoTable"></table>
            </div>

            <div class="section-title">üèõÔ∏è CARTERA INVERSI√ìN P√öBLICA</div>
            <div class="table-container">
                <table id="invPublicaTable"></table>
            </div>

            <div class="section-title">üìà INDICADORES PRODUCTIVO</div>
            <div class="table-container">
                <table id="indicadoresProductivoTable"></table>
            </div>

            <div class="section-title">üìâ INDICADORES INVERSI√ìN P√öBLICA</div>
            <div class="table-container">
                <table id="indicadoresInvTable"></table>
            </div>

            <div class="section-title">üíº PROVISIONES</div>
            <div class="table-container">
                <table id="provisionesTable"></table>
            </div>
        </div>

        <div class="export-section" id="exportSection" style="display: none;">
            <button id="exportBtn" class="export-btn">
                üì• Exportar a Excel
            </button>
        </div>
    </div>

    <script>
        let processingData = null;
        let fechasTrimestrales = [];

        // Generar fechas trimestrales din√°micamente bas√°ndose en datos disponibles
        function generarFechasTrimestralesDisponibles(vectorFechas) {
            const fechasTrimestrales = [];
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth() + 1; // getMonth() retorna 0-11
            
            // Generar fechas desde 2022 hasta el a√±o actual
            for (let year = 2022; year <= currentYear; year++) {
                const trimestres = [
                    { mes: 3, dia: 31, fecha: `31/03/${year}` },
                    { mes: 6, dia: 30, fecha: `30/06/${year}` },
                    { mes: 9, dia: 30, fecha: `30/09/${year}` },
                    { mes: 12, dia: 31, fecha: `31/12/${year}` }
                ];
                
                for (let trimestre of trimestres) {
                    // Solo incluir fechas que ya han pasado o est√°n en el mes actual
                    if (year < currentYear || 
                        (year === currentYear && trimestre.mes <= currentMonth)) {
                        
                        // Verificar si la fecha existe en los datos
                        if (vectorFechas.includes(trimestre.fecha)) {
                            fechasTrimestrales.push(trimestre.fecha);
                        }
                    }
                }
            }
            
            return fechasTrimestrales;
        }

        // Generar vector de fechas desde 2003
        function generarVectorFechas() {
            const fechas = [];
            let year = 2003;
            let month = 1;
            
            // Generar suficientes fechas (hasta 2025 aproximadamente)
            for (let i = 0; i < 275; i++) {
                let day;
                if (month === 2) {
                    day = ((year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0)) ? 29 : 28;
                } else if ([4, 6, 9, 11].includes(month)) {
                    day = 30;
                } else {
                    day = 31;
                }
                
                const dateStr = `${String(day).padStart(2, '0')}/${String(month).padStart(2, '0')}/${year}`;
                fechas.push(dateStr);
                
                month++;
                if (month > 12) {
                    month = 1;
                    year++;
                }
            }
            return fechas;
        }

        // Cargar datos por defecto desde GitHub
        async function cargarDatosPorDefecto() {
            try {
                const response = await fetch('BDD/BANCO DE DESARROLLO DEL ECUADOR B.P. 2025_06.xlsx');
                if (!response.ok) {
                    throw new Error('No se pudo cargar el archivo por defecto');
                }
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer);
                procesarWorkbook(workbook);
            } catch (error) {
                mostrarError('Error al cargar datos por defecto: ' + error.message);
            }
        }

        // Procesar archivo Excel
        function procesarWorkbook(workbook) {
            try {
                // Procesar hoja principal
                const mainSheet = workbook.Sheets[workbook.SheetNames[0]];
                const indicSheet = workbook.Sheets['INDIC CARTERA'];
                
                if (!mainSheet || !indicSheet) {
                    throw new Error('No se encontraron las hojas requeridas en el archivo');
                }

                // Obtener datos en formato JSON
                const mainData = XLSX.utils.sheet_to_json(mainSheet, { header: 1 });
                const indicData = XLSX.utils.sheet_to_json(indicSheet, { header: 1 });

                // Procesar datos
                const resultados = procesarDatos(mainData, indicData);
                mostrarResultados(resultados);
                
            } catch (error) {
                mostrarError('Error al procesar archivo: ' + error.message);
            }
        }

        // Procesar datos principales
        function procesarDatos(mainData, indicData) {
            // Aplicar nombres de columnas
            const vectorFechas = generarVectorFechas();
            
            // Generar fechas trimestrales din√°micamente bas√°ndose en datos disponibles
            fechasTrimestrales = generarFechasTrimestralesDisponibles(vectorFechas);

            // Procesar datos principales (desde fila 5, columnas 3 en adelante)
            const datosMain = mainData.slice(4).map(row => {
                const codigo = row[0];
                const cuenta = row[1];
                const valores = {};
                
                for (let i = 2; i < row.length - 2 && i - 2 < vectorFechas.length; i++) {
                    const fecha = vectorFechas[i - 2];
                    valores[fecha] = parseFloat(row[i]) || 0;
                }
                
                return { codigo, cuenta, valores };
            }).filter(row => row.codigo);

            // Procesar datos de indicadores
            const datosIndic = indicData.slice(4).map(row => {
                const item = row[0];
                const formula = row[1];
                const variables = row[2];
                const valores = {};
                
                for (let i = 3; i < row.length && i - 3 < vectorFechas.length; i++) {
                    const fecha = vectorFechas[i - 3];
                    valores[fecha] = parseFloat(row[i]) || 0;
                }
                
                return { item, formula, variables, valores };
            }).filter(row => row.item);

            // Procesar cada fecha trimestral disponible
            const resultados = {};
            
            fechasTrimestrales.forEach(fecha => {
                const resultado = procesarFechaTrimestral(fecha, datosMain, datosIndic);
                if (resultado) {
                    resultados[fecha] = resultado;
                }
            });

            return resultados;
        }

        // Procesar una fecha trimestral espec√≠fica
        function procesarFechaTrimestral(fecha, datosMain, datosIndic) {
            // Buscar datos para la fecha espec√≠fica
            const getValor = (codigo, datos) => {
                const registro = datos.find(d => d.codigo == codigo);
                return registro ? (registro.valores[fecha] || 0) : 0;
            };

            const getValorIndic = (item, datos) => {
                const registro = datos.find(d => d.item === item);
                return registro ? (registro.valores[fecha] || 0) : 0;
            };

            // SEGMENTO PRODUCTIVO
            const TOTAL_C_CREDITO_PRODUCTIVO = [1401, 1409, 1417, 1425, 1433, 1441, 1449, 1457, 1465]
                .reduce((sum, codigo) => sum + getValor(codigo, datosMain), 0);

            const TOTAL_PROVISIONES_ESPECIFICAS_C_PRODUCTIVO = 
                -getValor(149905, datosMain) + getValor(741401, datosMain) + getValor(741409, datosMain);

            const TOTAL_PROVISI√ìN_GEN√âRICA_C_PRODUCTIVO = getValor(741420, datosMain);

            const CARTERA_X_VENCER_C_PRODUCTIVO = [1401, 1409, 1417, 149105, 149405]
                .reduce((sum, codigo) => sum + getValor(codigo, datosMain), 0);

            const TOTAL_CARTERA_RIESGO_C_PRODUCTIVO = [1425, 1433, 1441, 1449, 1457, 1465]
                .reduce((sum, codigo) => sum + getValor(codigo, datosMain), 0);

            const CARTERA_NDI_C_PRODUCTIVO = [1425, 1433, 1441, 149205, 149505]
                .reduce((sum, codigo) => sum + getValor(codigo, datosMain), 0);

            const CARTERA_VENCIDA_C_PRODUCTIVO = [1449, 1457, 1465, 149305, 149605]
                .reduce((sum, codigo) => sum + getValor(codigo, datosMain), 0);

            // SEGMENTO INVERSI√ìN P√öBLICA
            const TOTAL_C_DE_CREDITO_C_IN_PUBLICO = [1474, 1476, 1478, 1480, 1482, 1484, 1486, 1488, 1490, 1491, 1492, 1493, 1494, 1495, 1496]
                .reduce((sum, codigo) => sum + getValor(codigo, datosMain), 0);

            const TOTAL_PROVISIONES_ESPECIFICAS_C_IN_PUBLICO = 
                -getValor(149960, datosMain) + getValor(741433, datosMain) + getValor(741437, datosMain);

            const TOTAL_PROVISI√ìN_GEN√âRICA_CREDITO_C_IN_PUBLICO = getValor(741442, datosMain);

            const CARTERA_X_VENCER_C_IN_PUBLICO = [1474, 1476, 1478, 1491, 1494]
                .reduce((sum, codigo) => sum + getValor(codigo, datosMain), 0);

            const TOTAL_CARTERA_RIESGO_C_IN_PUBLICO = [1480, 1482, 1484, 1486, 1488, 1490, 149245, 149345, 149545, 149645]
                .reduce((sum, codigo) => sum + getValor(codigo, datosMain), 0);

            const CARTERA_NDI_IN_PUBLICO = [1480, 1482, 1484, 149545, 149245]
                .reduce((sum, codigo) => sum + getValor(codigo, datosMain), 0);

            const CARTERA_VENCIDA_IN_PUBLICO = [1486, 1488, 1490, 149345, 149645]
                .reduce((sum, codigo) => sum + getValor(codigo, datosMain), 0);

            // C√ÅLCULOS DE PORCENTAJES
            const PORCENTAJE_CARTERA_X_VENCER_PROD = TOTAL_C_CREDITO_PRODUCTIVO !== 0 ? 
                (CARTERA_X_VENCER_C_PRODUCTIVO / TOTAL_C_CREDITO_PRODUCTIVO) * 100 : 0;

            const PORCENTA_CARTERA_NDI_PROD = TOTAL_C_CREDITO_PRODUCTIVO !== 0 ? 
                (CARTERA_NDI_C_PRODUCTIVO / TOTAL_C_CREDITO_PRODUCTIVO) * 100 : 0;

            const PORCENTAJE_CARTERA_VENCIDA_PROD = TOTAL_C_CREDITO_PRODUCTIVO !== 0 ? 
                (CARTERA_VENCIDA_C_PRODUCTIVO / TOTAL_C_CREDITO_PRODUCTIVO) * 100 : 0;

            const PORCENTAJE_CARTERA_RIESGO_PROD = PORCENTA_CARTERA_NDI_PROD + PORCENTAJE_CARTERA_VENCIDA_PROD;

            const PORCENTAJE_CARTERA_X_VENCER_IN_PUBLICO = TOTAL_C_DE_CREDITO_C_IN_PUBLICO !== 0 ? 
                (CARTERA_X_VENCER_C_IN_PUBLICO / TOTAL_C_DE_CREDITO_C_IN_PUBLICO) * 100 : 0;

            const PORCENTAJE_CARTERA_RIESGO_IN_PUBLICO = TOTAL_C_DE_CREDITO_C_IN_PUBLICO !== 0 ? 
                (TOTAL_CARTERA_RIESGO_C_IN_PUBLICO / TOTAL_C_DE_CREDITO_C_IN_PUBLICO) * 100 : 0;

            const PORCENTA_CARTERA_NDI_IN_PUBLICO = TOTAL_C_DE_CREDITO_C_IN_PUBLICO !== 0 ? 
                (CARTERA_NDI_IN_PUBLICO / TOTAL_C_DE_CREDITO_C_IN_PUBLICO) * 100 : 0;

            const PORCENTAJE_CARTERA_VENCIDA_IN_PUBLICO = TOTAL_C_DE_CREDITO_C_IN_PUBLICO !== 0 ? 
                (CARTERA_VENCIDA_IN_PUBLICO / TOTAL_C_DE_CREDITO_C_IN_PUBLICO) * 100 : 0;

            const CARTERA_INVERSI√ìN_P√öBLICA = PORCENTAJE_CARTERA_X_VENCER_IN_PUBLICO + PORCENTAJE_CARTERA_RIESGO_IN_PUBLICO;

            // COBERTURAS
            const Porcentaje_Cartera_productivo = TOTAL_CARTERA_RIESGO_C_PRODUCTIVO !== 0 ? 
                ((TOTAL_PROVISIONES_ESPECIFICAS_C_PRODUCTIVO + TOTAL_PROVISI√ìN_GEN√âRICA_C_PRODUCTIVO) / TOTAL_CARTERA_RIESGO_C_PRODUCTIVO * 100) : 0;

            const Porcentaje_Cartera_Inv_Publico = TOTAL_CARTERA_RIESGO_C_IN_PUBLICO !== 0 ? 
                ((TOTAL_PROVISIONES_ESPECIFICAS_C_IN_PUBLICO + TOTAL_PROVISI√ìN_GEN√âRICA_CREDITO_C_IN_PUBLICO) / TOTAL_CARTERA_RIESGO_C_IN_PUBLICO * 100) : 0;

            const PROVISIONES_PARA_CR√âDITOS_INCOBRABLES = getValor(1499, datosMain);
            const TOTAL_CARTERA_IMPRODUCTIVA = getValorIndic("(aw)", datosIndic);
            const COBERTURA_TOTAL_CARTERA = TOTAL_CARTERA_IMPRODUCTIVA !== 0 ? 
                (PROVISIONES_PARA_CR√âDITOS_INCOBRABLES / TOTAL_CARTERA_IMPRODUCTIVA) * -100 : 0;

            // PROVISIONES
            const Prov_Productivo = (-getValor(149905, datosMain) / 1000);
            const Prov_Inv_Publica = (-getValor(149960, datosMain) / 1000);
            const Prov_Refinanciada = (-getValor(149945, datosMain) / 1000);
            const Prov_Reestructurada = (-getValor(149950, datosMain) / 1000);
            const Prov_Anticiclica = (-getValor(149985, datosMain) / 1000);
            const Prov_No_Normativo = (-getValor(149987, datosMain) / 1000);
            const Prov_Voluntaria = (-getValor(149989, datosMain) / 1000);
            const Prov_Incombrables = (-getValor(1499, datosMain) / 1000);

            return {
                fecha,
                cartera_productivo: {
                    TOTAL_C_CREDITO_PRODUCTIVO: TOTAL_C_CREDITO_PRODUCTIVO * 1000,
                    TOTAL_PROVISIONES_ESPECIFICAS_C_PRODUCTIVO: TOTAL_PROVISIONES_ESPECIFICAS_C_PRODUCTIVO * 1000,
                    TOTAL_PROVISI√ìN_GEN√âRICA_C_PRODUCTIVO: TOTAL_PROVISI√ìN_GEN√âRICA_C_PRODUCTIVO * 1000,
                    CARTERA_X_VENCER_C_PRODUCTIVO: CARTERA_X_VENCER_C_PRODUCTIVO * 1000,
                    TOTAL_CARTERA_RIESGO_C_PRODUCTIVO: TOTAL_CARTERA_RIESGO_C_PRODUCTIVO * 1000,
                    CARTERA_NDI_C_PRODUCTIVO: CARTERA_NDI_C_PRODUCTIVO * 1000,
                    CARTERA_VENCIDA_C_PRODUCTIVO: CARTERA_VENCIDA_C_PRODUCTIVO * 1000
                },
                cartera_inv_publica: {
                    TOTAL_C_DE_CREDITO_C_IN_PUBLICO: TOTAL_C_DE_CREDITO_C_IN_PUBLICO * 1000,
                    TOTAL_PROVISIONES_ESPECIFICAS_C_IN_PUBLICO: TOTAL_PROVISIONES_ESPECIFICAS_C_IN_PUBLICO * 1000,
                    TOTAL_PROVISI√ìN_GEN√âRICA_CREDITO_C_IN_PUBLICO: TOTAL_PROVISI√ìN_GEN√âRICA_CREDITO_C_IN_PUBLICO * 1000,
                    CARTERA_X_VENCER_C_IN_PUBLICO: CARTERA_X_VENCER_C_IN_PUBLICO * 1000,
                    TOTAL_CARTERA_RIESGO_C_IN_PUBLICO: TOTAL_CARTERA_RIESGO_C_IN_PUBLICO * 1000,
                    CARTERA_NDI_IN_PUBLICO: CARTERA_NDI_IN_PUBLICO * 1000,
                    CARTERA_VENCIDA_IN_PUBLICO: CARTERA_VENCIDA_IN_PUBLICO * 1000
                },
                indicadores_productivo: {
                    CARTERA_PRODUCTIVO: PORCENTAJE_CARTERA_X_VENCER_PROD,
                    PORCENTAJE_CARTERA_X_VENCER: PORCENTAJE_CARTERA_X_VENCER_PROD,
                    PORCENTAJE_CARTERA_RIESGO: PORCENTAJE_CARTERA_RIESGO_PROD,
                    PORCENTAJE_CARTERA_NDI: PORCENTA_CARTERA_NDI_PROD,
                    PORCENTAJE_CARTERA_VENCIDA: PORCENTAJE_CARTERA_VENCIDA_PROD
                },
                indicadores_inv_publica: {
                    CARTERA_INVERSI√ìN_P√öBLICA: CARTERA_INVERSI√ìN_P√öBLICA,
                    PORCENTAJE_CARTERA_X_VENCER: PORCENTAJE_CARTERA_X_VENCER_IN_PUBLICO,
                    PORCENTAJE_CARTERA_RIESGO: PORCENTAJE_CARTERA_RIESGO_IN_PUBLICO,
                    PORCENTAJE_CARTERA_NDI: PORCENTA_CARTERA_NDI_IN_PUBLICO,
                    PORCENTAJE_CARTERA_VENCIDA: PORCENTAJE_CARTERA_VENCIDA_IN_PUBLICO
                },
                coberturas: {
                    COBERTURA_CARTERA_PRODUCTIVO: Porcentaje_Cartera_productivo,
                    COBERTURA_CARTERA_INVERSI√ìN_P√öBLICA: Porcentaje_Cartera_Inv_Publico,
                    COBERTURA_TOTAL_CARTERA: COBERTURA_TOTAL_CARTERA
                },
                provisiones: {
                    Productivo: Prov_Productivo,
                    Inversi√≥n_Publica: Prov_Inv_Publica,
                    Refinanciada: Prov_Refinanciada,
                    Reestructurada: Prov_Reestructurada,
                    Provisi√≥n_Antic√≠clica: Prov_Anticiclica,
                    Provisiones_no_reversadas: Prov_No_Normativo,
                    Provisi√≥n_gen√©rica_voluntaria: Prov_Voluntaria,
                    Provisiones_para_cr√©ditos_incobrables: Prov_Incombrables
                }
            };
        }

        // Mostrar resultados en tablas
        function mostrarResultados(resultados) {
            processingData = resultados;
            
            // Crear estructuras de datos para las tablas
            const fechas = Object.keys(resultados);
            
            // Crear tabla de coberturas
            const coberturasData = [
                ['COBERTURA CARTERA PRODUCTIVO (%)', ...fechas.map(f => resultados[f].coberturas.COBERTURA_CARTERA_PRODUCTIVO)],
                ['COBERTURA CARTERA INVERSI√ìN P√öBLICA (%)', ...fechas.map(f => resultados[f].coberturas.COBERTURA_CARTERA_INVERSI√ìN_P√öBLICA)],
                ['COBERTURA TOTAL CARTERA (%)', ...fechas.map(f => resultados[f].coberturas.COBERTURA_TOTAL_CARTERA)]
            ];
            
            // Crear tabla de cartera productivo
            const productivoData = [
                ['Total Cartera de Cr√©dito Productivo', ...fechas.map(f => resultados[f].cartera_productivo.TOTAL_C_CREDITO_PRODUCTIVO)],
                ['Total Provisiones Espec√≠ficas C. Productivo', ...fechas.map(f => resultados[f].cartera_productivo.TOTAL_PROVISIONES_ESPECIFICAS_C_PRODUCTIVO)],
                ['Total Provisi√≥n Gen√©rica C. Productivo', ...fechas.map(f => resultados[f].cartera_productivo.TOTAL_PROVISI√ìN_GEN√âRICA_C_PRODUCTIVO)],
                ['Cartera por Vencer C. Productivo', ...fechas.map(f => resultados[f].cartera_productivo.CARTERA_X_VENCER_C_PRODUCTIVO)],
                ['Total Cartera Riesgo C. Productivo', ...fechas.map(f => resultados[f].cartera_productivo.TOTAL_CARTERA_RIESGO_C_PRODUCTIVO)],
                ['Cartera NDI C. Productivo', ...fechas.map(f => resultados[f].cartera_productivo.CARTERA_NDI_C_PRODUCTIVO)],
                ['Cartera Vencida C. Productivo', ...fechas.map(f => resultados[f].cartera_productivo.CARTERA_VENCIDA_C_PRODUCTIVO)]
            ];
            
            // Crear tabla de cartera inversi√≥n p√∫blica
            const invPublicaData = [
                ['Total Cartera de Cr√©dito Inversi√≥n Publica', ...fechas.map(f => resultados[f].cartera_inv_publica.TOTAL_C_DE_CREDITO_C_IN_PUBLICO)],
                ['Total Provisiones Espec√≠ficas Inversi√≥n Publica', ...fechas.map(f => resultados[f].cartera_inv_publica.TOTAL_PROVISIONES_ESPECIFICAS_C_IN_PUBLICO)],
                ['Total Provisi√≥n Gen√©rica Inversi√≥n Publica', ...fechas.map(f => resultados[f].cartera_inv_publica.TOTAL_PROVISI√ìN_GEN√âRICA_CREDITO_C_IN_PUBLICO)],
                ['Cartera por Vencer Inversi√≥n Publica', ...fechas.map(f => resultados[f].cartera_inv_publica.CARTERA_X_VENCER_C_IN_PUBLICO)],
                ['Total Cartera Riesgo Inversi√≥n Publica', ...fechas.map(f => resultados[f].cartera_inv_publica.TOTAL_CARTERA_RIESGO_C_IN_PUBLICO)],
                ['Cartera NDI Inversi√≥n Publica', ...fechas.map(f => resultados[f].cartera_inv_publica.CARTERA_NDI_IN_PUBLICO)],
                ['Cartera Vencida Inversi√≥n Publica', ...fechas.map(f => resultados[f].cartera_inv_publica.CARTERA_VENCIDA_IN_PUBLICO)]
            ];
            
            // Crear tabla de indicadores productivo
            const indicadoresProductivoData = [
                ['CARTERA PRODUCTIVO', ...fechas.map(f => resultados[f].indicadores_productivo.CARTERA_PRODUCTIVO)],
                ['PORCENTAJE DE CARTERA POR VENCER', ...fechas.map(f => resultados[f].indicadores_productivo.PORCENTAJE_CARTERA_X_VENCER)],
                ['PORCENTAJE DE CARTERA EN RIESGO', ...fechas.map(f => resultados[f].indicadores_productivo.PORCENTAJE_CARTERA_RIESGO)],
                ['PORCENTAJE DE CARTERA QUE NO DEVENGA INTERES', ...fechas.map(f => resultados[f].indicadores_productivo.PORCENTAJE_CARTERA_NDI)],
                ['PORCENTAJE DE CARTERA VENCIDA', ...fechas.map(f => resultados[f].indicadores_productivo.PORCENTAJE_CARTERA_VENCIDA)]
            ];
            
            // Crear tabla de indicadores inversi√≥n p√∫blica
            const indicadoresInvData = [
                ['CARTERA INVERSI√ìN P√öBLICA', ...fechas.map(f => resultados[f].indicadores_inv_publica.CARTERA_INVERSI√ìN_P√öBLICA)],
                ['PORCENTAJE DE CARTERA POR VENCER', ...fechas.map(f => resultados[f].indicadores_inv_publica.PORCENTAJE_CARTERA_X_VENCER)],
                ['PORCENTAJE DE CARTERA EN RIESGO', ...fechas.map(f => resultados[f].indicadores_inv_publica.PORCENTAJE_CARTERA_RIESGO)],
                ['PORCENTA DE CARTERA QUE NO DEVENGA INTERES', ...fechas.map(f => resultados[f].indicadores_inv_publica.PORCENTAJE_CARTERA_NDI)],
                ['PORCENTAJE DE CARTERA VENCIDA', ...fechas.map(f => resultados[f].indicadores_inv_publica.PORCENTAJE_CARTERA_VENCIDA)]
            ];
            
            // Crear tabla de provisiones
            const provisionesData = [
                ['Productivo', ...fechas.map(f => resultados[f].provisiones.Productivo)],
                ['Inversi√≥n Publica', ...fechas.map(f => resultados[f].provisiones.Inversi√≥n_Publica)],
                ['Refinanciada', ...fechas.map(f => resultados[f].provisiones.Refinanciada)],
                ['Reestructurada', ...fechas.map(f => resultados[f].provisiones.Reestructurada)],
                ['Provisi√≥n Antic√≠clica', ...fechas.map(f => resultados[f].provisiones.Provisi√≥n_Antic√≠clica)],
                ['Provisiones no reversadas por requerimiento normativo', ...fechas.map(f => resultados[f].provisiones.Provisiones_no_reversadas)],
                ['Provisi√≥n gen√©rica voluntaria', ...fechas.map(f => resultados[f].provisiones.Provisi√≥n_gen√©rica_voluntaria)],
                ['Provisiones para cr√©ditos incobrables', ...fechas.map(f => resultados[f].provisiones.Provisiones_para_cr√©ditos_incobrables)]
            ];
            
            // Generar las tablas HTML
            generarTabla('coberturasTable', coberturasData, fechas, 'cobertura-row', 'percentage');
            generarTabla('productivoTable', productivoData, fechas, 'productivo-row', 'currency');
            generarTabla('invPublicaTable', invPublicaData, fechas, 'inv-publica-row', 'currency');
            generarTabla('indicadoresProductivoTable', indicadoresProductivoData, fechas, 'indicadores-prod-row', 'percentage');
            generarTabla('indicadoresInvTable', indicadoresInvData, fechas, 'indicadores-inv-row', 'percentage');
            generarTabla('provisionesTable', provisionesData, fechas, 'provisiones-row', 'currency');
            
            // Mostrar resultados y bot√≥n de exportar
            document.getElementById('results').style.display = 'block';
            document.getElementById('exportSection').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        // Generar tabla HTML
        function generarTabla(tableId, data, fechas, rowClass, format) {
            const table = document.getElementById(tableId);
            table.innerHTML = '';
            
            // Crear encabezado
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            const conceptoHeader = document.createElement('th');
            conceptoHeader.textContent = 'Concepto';
            headerRow.appendChild(conceptoHeader);
            
            fechas.forEach(fecha => {
                const th = document.createElement('th');
                th.textContent = fecha;
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Crear cuerpo de la tabla
            const tbody = document.createElement('tbody');
            
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = rowClass;
                
                row.forEach((cell, index) => {
                    const td = document.createElement('td');
                    
                    if (index === 0) {
                        td.textContent = cell;
                    } else {
                        const value = parseFloat(cell);
                        if (format === 'currency') {
                            td.textContent = formatCurrency(value);
                        } else if (format === 'percentage') {
                            td.textContent = formatPercentage(value);
                        } else {
                            td.textContent = formatNumber(value);
                        }
                    }
                    
                    tr.appendChild(td);
                });
                
                tbody.appendChild(tr);
            });
            
            table.appendChild(tbody);
        }

        // Funciones de formato
        function formatCurrency(value) {
            return new Intl.NumberFormat('es-EC', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        function formatPercentage(value) {
            return new Intl.NumberFormat('es-EC', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value) + '%';
        }

        function formatNumber(value) {
            return new Intl.NumberFormat('es-EC', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        // Exportar a Excel con formato profesional usando ExcelJS
        async function exportarExcel() {
            if (!processingData) {
                alert('No hay datos para exportar');
                return;
            }

            const fechas = Object.keys(processingData);
            
            // Crear workbook con ExcelJS
            const workbook = new ExcelJS.Workbook();
            workbook.creator = 'Sistema BDD';
            workbook.lastModifiedBy = 'Sistema BDD';
            workbook.created = new Date();
            workbook.modified = new Date();
            workbook.lastPrinted = new Date();

            // Crear hoja principal
            const worksheet = workbook.addWorksheet('Reporte Consolidado Trimestral');

            // Configurar columnas
            const columns = [
                { width: 45 }, // Columna de conceptos
                ...fechas.map(() => ({ width: 18 })) // Columnas de fechas
            ];
            worksheet.columns = columns;

            let currentRow = 1;

            // Definir secciones con sus datos y colores
            const secciones = [
                {
                    titulo: 'üìä COBERTURAS',
                    datos: [
                        ['COBERTURA CARTERA PRODUCTIVO (%)', ...fechas.map(f => processingData[f].coberturas.COBERTURA_CARTERA_PRODUCTIVO)],
                        ['COBERTURA CARTERA INVERSI√ìN P√öBLICA (%)', ...fechas.map(f => processingData[f].coberturas.COBERTURA_CARTERA_INVERSI√ìN_P√öBLICA)],
                        ['COBERTURA TOTAL CARTERA (%)', ...fechas.map(f => processingData[f].coberturas.COBERTURA_TOTAL_CARTERA)]
                    ],
                    bgColor: 'FCF3CF'
                },
                {
                    titulo: 'üí∞ CARTERA PRODUCTIVO',
                    datos: [
                        ['Total Cartera de Cr√©dito Productivo', ...fechas.map(f => processingData[f].cartera_productivo.TOTAL_C_CREDITO_PRODUCTIVO)],
                        ['Total Provisiones Espec√≠ficas C. Productivo', ...fechas.map(f => processingData[f].cartera_productivo.TOTAL_PROVISIONES_ESPECIFICAS_C_PRODUCTIVO)],
                        ['Total Provisi√≥n Gen√©rica C. Productivo', ...fechas.map(f => processingData[f].cartera_productivo.TOTAL_PROVISI√ìN_GEN√âRICA_C_PRODUCTIVO)],
                        ['Cartera por Vencer C. Productivo', ...fechas.map(f => processingData[f].cartera_productivo.CARTERA_X_VENCER_C_PRODUCTIVO)],
                        ['Total Cartera Riesgo C. Productivo', ...fechas.map(f => processingData[f].cartera_productivo.TOTAL_CARTERA_RIESGO_C_PRODUCTIVO)],
                        ['Cartera NDI C. Productivo', ...fechas.map(f => processingData[f].cartera_productivo.CARTERA_NDI_C_PRODUCTIVO)],
                        ['Cartera Vencida C. Productivo', ...fechas.map(f => processingData[f].cartera_productivo.CARTERA_VENCIDA_C_PRODUCTIVO)]
                    ],
                    bgColor: 'EBF5FB'
                },
                {
                    titulo: 'üèõÔ∏è CARTERA INVERSI√ìN P√öBLICA',
                    datos: [
                        ['Total Cartera de Cr√©dito Inversi√≥n Publica', ...fechas.map(f => processingData[f].cartera_inv_publica.TOTAL_C_DE_CREDITO_C_IN_PUBLICO)],
                        ['Total Provisiones Espec√≠ficas Inversi√≥n Publica', ...fechas.map(f => processingData[f].cartera_inv_publica.TOTAL_PROVISIONES_ESPECIFICAS_C_IN_PUBLICO)],
                        ['Total Provisi√≥n Gen√©rica Inversi√≥n Publica', ...fechas.map(f => processingData[f].cartera_inv_publica.TOTAL_PROVISI√ìN_GEN√âRICA_CREDITO_C_IN_PUBLICO)],
                        ['Cartera por Vencer Inversi√≥n Publica', ...fechas.map(f => processingData[f].cartera_inv_publica.CARTERA_X_VENCER_C_IN_PUBLICO)],
                        ['Total Cartera Riesgo Inversi√≥n Publica', ...fechas.map(f => processingData[f].cartera_inv_publica.TOTAL_CARTERA_RIESGO_C_IN_PUBLICO)],
                        ['Cartera NDI Inversi√≥n Publica', ...fechas.map(f => processingData[f].cartera_inv_publica.CARTERA_NDI_IN_PUBLICO)],
                        ['Cartera Vencida Inversi√≥n Publica', ...fechas.map(f => processingData[f].cartera_inv_publica.CARTERA_VENCIDA_IN_PUBLICO)]
                    ],
                    bgColor: 'E8F8F5'
                },
                {
                    titulo: 'üìà INDICADORES PRODUCTIVO',
                    datos: [
                        ['CARTERA PRODUCTIVO', ...fechas.map(f => processingData[f].indicadores_productivo.CARTERA_PRODUCTIVO)],
                        ['PORCENTAJE DE CARTERA POR VENCER', ...fechas.map(f => processingData[f].indicadores_productivo.PORCENTAJE_CARTERA_X_VENCER)],
                        ['PORCENTAJE DE CARTERA EN RIESGO', ...fechas.map(f => processingData[f].indicadores_productivo.PORCENTAJE_CARTERA_RIESGO)],
                        ['PORCENTAJE DE CARTERA QUE NO DEVENGA INTERES', ...fechas.map(f => processingData[f].indicadores_productivo.PORCENTAJE_CARTERA_NDI)],
                        ['PORCENTAJE DE CARTERA VENCIDA', ...fechas.map(f => processingData[f].indicadores_productivo.PORCENTAJE_CARTERA_VENCIDA)]
                    ],
                    bgColor: 'FEF9E7'
                },
                {
                    titulo: 'üìâ INDICADORES INVERSI√ìN P√öBLICA',
                    datos: [
                        ['CARTERA INVERSI√ìN P√öBLICA', ...fechas.map(f => processingData[f].indicadores_inv_publica.CARTERA_INVERSI√ìN_P√öBLICA)],
                        ['PORCENTAJE DE CARTERA POR VENCER', ...fechas.map(f => processingData[f].indicadores_inv_publica.PORCENTAJE_CARTERA_X_VENCER)],
                        ['PORCENTAJE DE CARTERA EN RIESGO', ...fechas.map(f => processingData[f].indicadores_inv_publica.PORCENTAJE_CARTERA_RIESGO)],
                        ['PORCENTA DE CARTERA QUE NO DEVENGA INTERES', ...fechas.map(f => processingData[f].indicadores_inv_publica.PORCENTAJE_CARTERA_NDI)],
                        ['PORCENTAJE DE CARTERA VENCIDA', ...fechas.map(f => processingData[f].indicadores_inv_publica.PORCENTAJE_CARTERA_VENCIDA)]
                    ],
                    bgColor: 'F4ECF7'
                },
                {
                    titulo: 'üíº PROVISIONES',
                    datos: [
                        ['Productivo', ...fechas.map(f => processingData[f].provisiones.Productivo)],
                        ['Inversi√≥n Publica', ...fechas.map(f => processingData[f].provisiones.Inversi√≥n_Publica)],
                        ['Refinanciada', ...fechas.map(f => processingData[f].provisiones.Refinanciada)],
                        ['Reestructurada', ...fechas.map(f => processingData[f].provisiones.Reestructurada)],
                        ['Provisi√≥n Antic√≠clica', ...fechas.map(f => processingData[f].provisiones.Provisi√≥n_Antic√≠clica)],
                        ['Provisiones no reversadas por requerimiento normativo', ...fechas.map(f => processingData[f].provisiones.Provisiones_no_reversadas)],
                        ['Provisi√≥n gen√©rica voluntaria', ...fechas.map(f => processingData[f].provisiones.Provisi√≥n_gen√©rica_voluntaria)],
                        ['Provisiones para cr√©ditos incobrables', ...fechas.map(f => processingData[f].provisiones.Provisiones_para_cr√©ditos_incobrables)]
                    ],
                    bgColor: 'F8F9FA'
                }
            ];

            // Agregar cada secci√≥n
            secciones.forEach((seccion, seccionIndex) => {
                // Agregar t√≠tulo de secci√≥n
                const tituloRow = worksheet.getRow(currentRow);
                tituloRow.getCell(1).value = seccion.titulo;
                
                // Fusionar celdas del t√≠tulo
                worksheet.mergeCells(currentRow, 1, currentRow, fechas.length + 1);
                
                // Estilo del t√≠tulo
                tituloRow.getCell(1).font = { 
                    bold: true, 
                    color: { argb: 'FFFFFFFF' }, 
                    size: 13 
                };
                tituloRow.getCell(1).fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: 'FF34495E' }
                };
                tituloRow.getCell(1).alignment = { 
                    horizontal: 'center', 
                    vertical: 'middle' 
                };
                tituloRow.height = 25;
                currentRow++;

                // Agregar encabezados
                const headerRow = worksheet.getRow(currentRow);
                headerRow.getCell(1).value = 'Concepto';
                fechas.forEach((fecha, index) => {
                    headerRow.getCell(index + 2).value = fecha;
                });

                // Estilo de encabezados
                for (let col = 1; col <= fechas.length + 1; col++) {
                    const cell = headerRow.getCell(col);
                    cell.font = { 
                        bold: true, 
                        color: { argb: 'FFFFFFFF' }, 
                        size: 11 
                    };
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FF2C3E50' }
                    };
                    cell.alignment = { 
                        horizontal: 'center', 
                        vertical: 'middle' 
                    };
                }
                headerRow.height = 20;
                currentRow++;

                // Agregar datos
                seccion.datos.forEach(fila => {
                    const dataRow = worksheet.getRow(currentRow);
                    
                    // Agregar concepto
                    dataRow.getCell(1).value = fila[0];
                    dataRow.getCell(1).font = { 
                        bold: true, 
                        color: { argb: 'FF333333' } 
                    };
                    dataRow.getCell(1).alignment = { 
                        horizontal: 'left' 
                    };

                    // Agregar valores num√©ricos
                    fila.slice(1).forEach((valor, index) => {
                        const cell = dataRow.getCell(index + 2);
                        cell.value = parseFloat(valor);
                        cell.numFmt = '#,##0.00';
                        cell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FF' + seccion.bgColor }
                        };
                        cell.alignment = { 
                            horizontal: 'right' 
                        };
                    });

                    dataRow.height = 18;
                    currentRow++;
                });

                // Agregar espacio entre secciones
                if (seccionIndex < secciones.length - 1) {
                    currentRow++;
                }
            });

            // Agregar filtros
            worksheet.autoFilter = {
                from: { row: 2, column: 1 },
                to: { row: 2, column: fechas.length + 1 }
            };

            // Crear hoja de resumen
            const resumenSheet = workbook.addWorksheet('Resumen');
            resumenSheet.columns = [{ width: 50 }, { width: 30 }];

            const resumenData = [
                ['REPORTE CONSOLIDADO TRIMESTRAL'],
                ['Banco de Desarrollo del Ecuador'],
                [''],
                ['Fecha de generaci√≥n:', new Date().toLocaleDateString('es-EC')],
                ['Per√≠odos analizados:', `${fechas[0]} a ${fechas[fechas.length - 1]}`],
                ['Total de trimestres:', fechas.length],
                [''],
                ['CONTENIDO DEL REPORTE:'],
                ['‚Ä¢ Coberturas de Cartera'],
                ['‚Ä¢ Cartera Productivo'],
                ['‚Ä¢ Cartera Inversi√≥n P√∫blica'],
                ['‚Ä¢ Indicadores Productivo'],
                ['‚Ä¢ Indicadores Inversi√≥n P√∫blica'],
                ['‚Ä¢ Provisiones'],
                [''],
                ['NOTAS:'],
                ['‚Ä¢ Los valores monetarios est√°n expresados en d√≥lares estadounidenses'],
                ['‚Ä¢ Los porcentajes se muestran con 2 decimales'],
                ['‚Ä¢ Los datos corresponden a fechas trimestrales efectivamente procesadas']
            ];

            resumenData.forEach((fila, index) => {
                const row = resumenSheet.getRow(index + 1);
                if (Array.isArray(fila)) {
                    row.getCell(1).value = fila[0];
                    row.getCell(2).value = fila[1];
                } else {
                    row.getCell(1).value = fila;
                }

                // Estilo especial para t√≠tulos
                if (index === 0 || index === 1) {
                    row.getCell(1).font = { bold: true, size: 14 };
                    row.getCell(1).fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFE8F4F8' }
                    };
                }
            });

            // Exportar archivo
            try {
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { 
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                });
                
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                
                const timestamp = new Date().toISOString().slice(0, 10);
                link.download = `Reporte_Consolidado_Trimestral_BDD_${timestamp}.xlsx`;
                
                link.click();
                window.URL.revokeObjectURL(url);
                
            } catch (error) {
                console.error('Error al exportar:', error);
                alert('Error al generar el archivo Excel. Intenta de nuevo.');
            }
        }

        // Mostrar error
        function mostrarError(mensaje) {
            document.getElementById('loading').style.display = 'none';
            const container = document.querySelector('.container');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-panel';
            errorDiv.innerHTML = `<strong>‚ùå Error:</strong> ${mensaje}`;
            container.appendChild(errorDiv);
            
            setTimeout(() => errorDiv.remove(), 5000);
        }

        // Event Listeners
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('processBtn').disabled = false;
                document.querySelector('.file-input-label').textContent = `üìÅ ${file.name}`;
            }
        });

        document.getElementById('loadDefault').addEventListener('click', function() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('exportSection').style.display = 'none';
            cargarDatosPorDefecto();
        });

        document.getElementById('processBtn').addEventListener('click', function() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return;

            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('exportSection').style.display = 'none';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const workbook = XLSX.read(e.target.result, { type: 'binary' });
                    procesarWorkbook(workbook);
                } catch (error) {
                    mostrarError('Error al leer el archivo: ' + error.message);
                }
            };
            reader.readAsBinaryString(file);
        });

        document.getElementById('exportBtn').addEventListener('click', exportarExcel);

        // Cargar datos por defecto al inicio
        window.addEventListener('load', function() {
            setTimeout(() => {
                document.getElementById('loading').style.display = 'block';
                cargarDatosPorDefecto();
            }, 1000);
        });
    </script>
</body>
</html>
