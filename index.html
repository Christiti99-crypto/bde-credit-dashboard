<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banco de Desarrollo del Ecuador - Analizador Trimestral</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .upload-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .file-upload {
            border: 2px dashed #3498db;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload:hover {
            border-color: #2980b9;
            background: rgba(52, 152, 219, 0.05);
        }

        .file-upload.dragover {
            border-color: #27ae60;
            background: rgba(39, 174, 96, 0.1);
        }

        .upload-icon {
            font-size: 3em;
            color: #3498db;
            margin-bottom: 15px;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-success {
            background: linear-gradient(45deg, #27ae60, #229954);
        }

        .btn-download {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            background: linear-gradient(45deg, #34495e, #2c3e50);
            color: white;
            padding: 15px;
            margin: 20px 0 0 0;
            border-radius: 10px;
            font-weight: bold;
            text-align: center;
        }

        .section-title:first-of-type {
            margin-top: 0;
        }

        .table-container {
            overflow-x: auto;
            margin: 15px 0;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }

        th {
            background: #2c3e50;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid #ecf0f1;
        }

        tr:hover {
            background: rgba(52, 152, 219, 0.05);
        }

        .concept-column {
            font-weight: 600;
            color: #2c3e50;
        }

        .number-column {
            text-align: right;
            font-family: 'Consolas', monospace;
        }

        .coberturas { background: rgba(252, 243, 207, 0.5); }
        .productivo { background: rgba(235, 245, 251, 0.5); }
        .inv-publica { background: rgba(232, 248, 245, 0.5); }
        .indicadores-prod { background: rgba(254, 249, 231, 0.5); }
        .indicadores-inv { background: rgba(244, 236, 247, 0.5); }
        .provisiones { background: rgba(248, 249, 250, 0.5); }

        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
        }

        .success {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
        }

        .controls {
            text-align: center;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            table {
                font-size: 0.9em;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¶ Banco de Desarrollo del Ecuador</h1>
            <p>Analizador de Cartera Trimestral - Reporte Consolidado</p>
        </div>

        <div class="upload-section">
            <h3>üìÅ Cargar Archivo Excel</h3>
            <div class="file-upload" id="fileUpload">
                <div class="upload-icon">üìä</div>
                <p><strong>Arrastra el archivo Excel aqu√≠ o haz clic para seleccionar</strong></p>
                <p>Formato esperado: BANCO DE DESARROLLO DEL ECUADOR B.P. YYYY_MM.xlsx</p>
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls">
            </div>
            
            <div class="controls">
                <button class="btn" onclick="loadDefaultFile()">üìà Cargar Datos por Defecto (2025_06)</button>
                <button class="btn btn-success" onclick="processFile()" id="processBtn" style="display:none;">üîÑ Procesar Archivo</button>
            </div>

            <div class="error" id="errorMsg"></div>
            <div class="success" id="successMsg"></div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Procesando archivo Excel...</p>
        </div>

        <div class="results" id="results">
            <div class="controls">
                <button class="btn btn-download" onclick="downloadExcel()">üíæ Descargar Reporte Excel</button>
            </div>
            <div id="tablesContainer"></div>
        </div>
    </div>

    <script>
        let currentData = null;
        let processedResults = null;

        // Configuraci√≥n de carga de archivos
        const fileUpload = document.getElementById('fileUpload');
        const fileInput = document.getElementById('fileInput');

        fileUpload.addEventListener('click', () => fileInput.click());
        fileUpload.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUpload.classList.add('dragover');
        });
        fileUpload.addEventListener('dragleave', () => {
            fileUpload.classList.remove('dragover');
        });
        fileUpload.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUpload.classList.remove('dragover');
            handleFile(e.dataTransfer.files[0]);
        });

        fileInput.addEventListener('change', (e) => {
            handleFile(e.target.files[0]);
        });

        function handleFile(file) {
            if (!file) return;
            
            if (!file.name.toLowerCase().endsWith('.xlsx') && !file.name.toLowerCase().endsWith('.xls')) {
                showError('Por favor selecciona un archivo Excel (.xlsx o .xls)');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    currentData = new Uint8Array(e.target.result);
                    showSuccess(`Archivo "${file.name}" cargado correctamente`);
                    document.getElementById('processBtn').style.display = 'inline-block';
                } catch (error) {
                    showError('Error al leer el archivo: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        async function loadDefaultFile() {
            showLoading(true);
            try {
                // Intentar cargar el archivo por defecto desde la ruta especificada
                const response = await fetch('BDD/BANCO DE DESARROLLO DEL ECUADOR B.P. 2025_06.xlsx');
                if (!response.ok) {
                    throw new Error(`No se pudo cargar el archivo por defecto. C√≥digo: ${response.status}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                currentData = new Uint8Array(arrayBuffer);
                showSuccess('Archivo por defecto cargado correctamente (2025_06)');
                processFile();
            } catch (error) {
                showError('No se pudo cargar el archivo por defecto. Por favor, sube manualmente el archivo Excel.');
                console.error('Error:', error);
            } finally {
                showLoading(false);
            }
        }

        function processFile() {
            if (!currentData) {
                showError('No hay archivo para procesar');
                return;
            }

            showLoading(true);
            
            setTimeout(() => {
                try {
                    const workbook = XLSX.read(currentData, {
                        cellStyles: true,
                        cellFormulas: true,
                        cellDates: true,
                        cellNF: true,
                        sheetStubs: true
                    });

                    // Procesar las hojas BAL e INDIC CARTERA
                    const balSheet = workbook.Sheets['BAL'];
                    const indicSheet = workbook.Sheets['INDIC CARTERA'];

                    if (!balSheet || !indicSheet) {
                        throw new Error('No se encontraron las hojas "BAL" e "INDIC CARTERA" en el archivo Excel');
                    }

                    // Convertir a JSON saltando las primeras 4 filas (skip = 4)
                    const balData = XLSX.utils.sheet_to_json(balSheet, { range: 4 });
                    const indicData = XLSX.utils.sheet_to_json(indicSheet, { range: 4 });

                    // Procesar los datos
                    processedResults = processBankData(balData, indicData);
                    
                    displayResults(processedResults);
                    showSuccess('Datos procesados correctamente');
                    document.getElementById('results').style.display = 'block';
                    
                } catch (error) {
                    showError('Error al procesar el archivo: ' + error.message);
                    console.error('Error completo:', error);
                } finally {
                    showLoading(false);
                }
            }, 100);
        }

        function processBankData(balData, indicData) {
            // Crear fechas trimestrales de los √∫ltimos 3 a√±os
            const fechasTrimestrales = [];
            const currentYear = 2025;
            
            for (let year = currentYear - 2; year <= currentYear; year++) {
                fechasTrimestrales.push(`31/03/${year}`);
                fechasTrimestrales.push(`30/06/${year}`);
                fechasTrimestrales.push(`30/09/${year}`);
                fechasTrimestrales.push(`31/12/${year}`);
            }

            // Obtener las √∫ltimas 3 fechas disponibles
            const fechasDisponibles = fechasTrimestrales.slice(-3);
            
            const results = {};

            fechasDisponibles.forEach(fecha => {
                const fechaFormatted = formatDateForExcel(fecha);
                results[fecha] = procesarFechaTrimestral(fecha, fechaFormatted, balData, indicData);
            });

            return results;
        }

        function formatDateForExcel(dateStr) {
            // Convertir formato DD/MM/YYYY a formato que Excel podr√≠a usar
            const parts = dateStr.split('/');
            return `${parts[2]}-${parts[1]}-${parts[0]}`;
        }

        function procesarFechaTrimestral(fecha, fechaCol, balData, indicData) {
            // Funci√≥n auxiliar para buscar valores por c√≥digo
            const findByCode = (code) => {
                const row = balData.find(r => r['__EMPTY'] == code || r['C√ìDIGO'] == code);
                return row ? (row[fechaCol] || row[fecha] || 0) : 0;
            };

            const findByCodeArray = (codes) => {
                return codes.reduce((sum, code) => sum + findByCode(code), 0);
            };

            // SEGMENTO PRODUCTIVO
            const TOTAL_C_CREDITO_PRODUCTIVO = findByCodeArray([1401, 1409, 1417, 1425, 1433, 1441, 1449, 1457, 1465]);
            
            let prov149905 = findByCode('149905') * -1;
            const TOTAL_PROVISIONES_ESPECIFICAS_C_PRODUCTIVO = prov149905 + findByCodeArray(['741401', '741409']);
            
            const TOTAL_PROVISI√ìN_GEN√âRICA_C_PRODUCTIVO = findByCode('741420');
            const CARTERA_X_VENCER_C_PRODUCTIVO = findByCodeArray([1401, 1409, 1417, '149105', '149405']);
            const TOTAL_CARTERA_RIESGO_C_PRODUCTIVO = findByCodeArray([1425, 1433, 1441, 1449, 1457, 1465]);
            const CARTERA_NDI_C_PRODUCTIVO = findByCodeArray([1425, 1433, 1441, '149205', '149505']);
            const CARTERA_VENCIDA_C_PRODUCTIVO = findByCodeArray([1449, 1457, 1465, '149305', '149605']);

            // SEGMENTO INVERSI√ìN P√öBLICA
            const TOTAL_C_DE_CREDITO_C_IN_PUBLICO = findByCodeArray([1474, 1476, 1478, 1480, 1482, 1484, 1486, 1488, 1490, 1491, 1492, 1493, 1494, 1495, 1496]);
            
            let prov149960 = findByCode('149960') * -1;
            const TOTAL_PROVISIONES_ESPECIFICAS_C_IN_PUBLICO = prov149960 + findByCodeArray(['741433', '741437']);
            
            const TOTAL_PROVISI√ìN_GEN√âRICA_CREDITO_C_IN_PUBLICO = findByCode('741442');
            const TOTAL_CARTERA_RIESGO_C_IN_PUBLICO = findByCodeArray([1480, 1482, 1484, 1486, 1488, 1490, '149245', '149345', '149545', '149645']);
            const CARTERA_X_VENCER_C_IN_PUBLICO = findByCodeArray([1474, 1476, 1478, 1491, 1494]);
            const CARTERA_NDI_IN_PUBLICO = findByCodeArray([1480, 1482, 1484, '149545', '149245']);
            const CARTERA_VENCIDA_IN_PUBLICO = findByCodeArray([1486, 1488, 1490, '149345', '149645']);

            // C√°lculos de porcentajes
            const PORCENTAJE_CARTERA_X_VENCER_PROD = TOTAL_C_CREDITO_PRODUCTIVO !== 0 ? (CARTERA_X_VENCER_C_PRODUCTIVO / TOTAL_C_CREDITO_PRODUCTIVO) * 100 : 0;
            const PORCENTA_CARTERA_NDI_PROD = TOTAL_C_CREDITO_PRODUCTIVO !== 0 ? (CARTERA_NDI_C_PRODUCTIVO / TOTAL_C_CREDITO_PRODUCTIVO) * 100 : 0;
            const PORCENTAJE_CARTERA_VENCIDA_PROD = TOTAL_C_CREDITO_PRODUCTIVO !== 0 ? (CARTERA_VENCIDA_C_PRODUCTIVO / TOTAL_C_CREDITO_PRODUCTIVO) * 100 : 0;
            const PORCENTAJE_CARTERA_RIESGO_PROD = PORCENTA_CARTERA_NDI_PROD + PORCENTAJE_CARTERA_VENCIDA_PROD;

            const PORCENTAJE_CARTERA_X_VENCER_IN_PUBLICO = TOTAL_C_DE_CREDITO_C_IN_PUBLICO !== 0 ? (CARTERA_X_VENCER_C_IN_PUBLICO / TOTAL_C_DE_CREDITO_C_IN_PUBLICO) * 100 : 0;
            const PORCENTAJE_CARTERA_RIESGO_IN_PUBLICO = TOTAL_C_DE_CREDITO_C_IN_PUBLICO !== 0 ? (TOTAL_CARTERA_RIESGO_C_IN_PUBLICO / TOTAL_C_DE_CREDITO_C_IN_PUBLICO) * 100 : 0;
            const PORCENTA_CARTERA_NDI_IN_PUBLICO = TOTAL_C_DE_CREDITO_C_IN_PUBLICO !== 0 ? (CARTERA_NDI_IN_PUBLICO / TOTAL_C_DE_CREDITO_C_IN_PUBLICO) * 100 : 0;
            const PORCENTAJE_CARTERA_VENCIDA_IN_PUBLICO = TOTAL_C_DE_CREDITO_C_IN_PUBLICO !== 0 ? (CARTERA_VENCIDA_IN_PUBLICO / TOTAL_C_DE_CREDITO_C_IN_PUBLICO) * 100 : 0;
            const CARTERA_INVERSI√ìN_P√öBLICA = PORCENTAJE_CARTERA_X_VENCER_IN_PUBLICO + PORCENTAJE_CARTERA_RIESGO_IN_PUBLICO;

            // Coberturas
            const Porcentaje_Cartera_productivo = TOTAL_CARTERA_RIESGO_C_PRODUCTIVO !== 0 ? ((TOTAL_PROVISIONES_ESPECIFICAS_C_PRODUCTIVO + TOTAL_PROVISI√ìN_GEN√âRICA_C_PRODUCTIVO) / TOTAL_CARTERA_RIESGO_C_PRODUCTIVO * 100) : 0;
            const Porcentaje_Cartera_Inv_Publico = TOTAL_CARTERA_RIESGO_C_IN_PUBLICO !== 0 ? ((TOTAL_PROVISIONES_ESPECIFICAS_C_IN_PUBLICO + TOTAL_PROVISI√ìN_GEN√âRICA_CREDITO_C_IN_PUBLICO) / TOTAL_CARTERA_RIESGO_C_IN_PUBLICO * 100) : 0;

            // Cobertura total (simplificado)
            const PROVISIONES_PARA_CR√âDITOS_INCOBRABLES = findByCode('1499');
            const TOTAL_CARTERA_IMPRODUCTIVA = CARTERA_NDI_C_PRODUCTIVO + CARTERA_VENCIDA_C_PRODUCTIVO + CARTERA_NDI_IN_PUBLICO + CARTERA_VENCIDA_IN_PUBLICO;
            const COBERTURA_TOTAL_CARTERA = TOTAL_CARTERA_IMPRODUCTIVA !== 0 ? (PROVISIONES_PARA_CR√âDITOS_INCOBRABLES / TOTAL_CARTERA_IMPRODUCTIVA) * -100 : 0;

            return {
                fecha,
                TOTAL_C_CREDITO_PRODUCTIVO: TOTAL_C_CREDITO_PRODUCTIVO * 1000,
                TOTAL_PROVISIONES_ESPECIFICAS_C_PRODUCTIVO: TOTAL_PROVISIONES_ESPECIFICAS_C_PRODUCTIVO * 1000,
                TOTAL_PROVISI√ìN_GEN√âRICA_C_PRODUCTIVO: TOTAL_PROVISI√ìN_GEN√âRICA_C_PRODUCTIVO * 1000,
                CARTERA_X_VENCER_C_PRODUCTIVO: CARTERA_X_VENCER_C_PRODUCTIVO * 1000,
                TOTAL_CARTERA_RIESGO_C_PRODUCTIVO: TOTAL_CARTERA_RIESGO_C_PRODUCTIVO * 1000,
                CARTERA_NDI_C_PRODUCTIVO: CARTERA_NDI_C_PRODUCTIVO * 1000,
                CARTERA_VENCIDA_C_PRODUCTIVO: CARTERA_VENCIDA_C_PRODUCTIVO * 1000,

                TOTAL_C_DE_CREDITO_C_IN_PUBLICO: TOTAL_C_DE_CREDITO_C_IN_PUBLICO * 1000,
                TOTAL_PROVISIONES_ESPECIFICAS_C_IN_PUBLICO: TOTAL_PROVISIONES_ESPECIFICAS_C_IN_PUBLICO * 1000,
                TOTAL_PROVISI√ìN_GEN√âRICA_CREDITO_C_IN_PUBLICO: TOTAL_PROVISI√ìN_GEN√âRICA_CREDITO_C_IN_PUBLICO * 1000,
                CARTERA_X_VENCER_C_IN_PUBLICO: CARTERA_X_VENCER_C_IN_PUBLICO * 1000,
                TOTAL_CARTERA_RIESGO_C_IN_PUBLICO: TOTAL_CARTERA_RIESGO_C_IN_PUBLICO * 1000,
                CARTERA_NDI_IN_PUBLICO: CARTERA_NDI_IN_PUBLICO * 1000,
                CARTERA_VENCIDA_IN_PUBLICO: CARTERA_VENCIDA_IN_PUBLICO * 1000,

                PORCENTAJE_CARTERA_X_VENCER_PROD,
                PORCENTAJE_CARTERA_RIESGO_PROD,
                PORCENTA_CARTERA_NDI_PROD,
                PORCENTAJE_CARTERA_VENCIDA_PROD,

                CARTERA_INVERSI√ìN_P√öBLICA,
                PORCENTAJE_CARTERA_X_VENCER_IN_PUBLICO,
                PORCENTAJE_CARTERA_RIESGO_IN_PUBLICO,
                PORCENTA_CARTERA_NDI_IN_PUBLICO,
                PORCENTAJE_CARTERA_VENCIDA_IN_PUBLICO,

                Porcentaje_Cartera_productivo,
                Porcentaje_Cartera_Inv_Publico,
                COBERTURA_TOTAL_CARTERA,

                Prov_Productivo: (findByCode('149905') / 1000) * -1,
                Prov_Inv_Publica: (findByCode('149960') / 1000) * -1,
                Prov_Refinanciada: (findByCode('149945') / 1000) * -1,
                Prov_Reestructurada: (findByCode('149950') / 1000) * -1,
                Prov_Anticiclica: (findByCode('149985') / 1000) * -1,
                Prov_No_Normativo: (findByCode('149987') / 1000) * -1,
                Prov_Voluntaria: (findByCode('149989') / 1000) * -1,
                Prov_Incombrables: (findByCode('1499') / 1000) * -1
            };
        }

        function displayResults(results) {
            const container = document.getElementById('tablesContainer');
            const fechas = Object.keys(results).sort();
            
            container.innerHTML = `
                <div class="section-title">üìä COBERTURAS</div>
                ${createTable('coberturas', [
                    'COBERTURA CARTERA PRODUCTIVO (%)',
                    'COBERTURA CARTERA INVERSI√ìN P√öBLICA (%)',
                    'COBERTURA TOTAL CARTERA (%)'
                ], fechas, results, [
                    'Porcentaje_Cartera_productivo',
                    'Porcentaje_Cartera_Inv_Publico',
                    'COBERTURA_TOTAL_CARTERA'
                ], true)}

                <div class="section-title">üí∞ CARTERA PRODUCTIVO</div>
                ${createTable('productivo', [
                    'Total Cartera de Cr√©dito Productivo',
                    'Total Provisiones Espec√≠ficas C. Productivo',
                    'Total Provisi√≥n Gen√©rica C. Productivo',
                    'Cartera por Vencer C. Productivo',
                    'Total Cartera Riesgo C. Productivo',
                    'Cartera NDI C. Productivo',
                    'Cartera Vencida C. Productivo'
                ], fechas, results, [
                    'TOTAL_C_CREDITO_PRODUCTIVO',
                    'TOTAL_PROVISIONES_ESPECIFICAS_C_PRODUCTIVO',
                    'TOTAL_PROVISI√ìN_GEN√âRICA_C_PRODUCTIVO',
                    'CARTERA_X_VENCER_C_PRODUCTIVO',
                    'TOTAL_CARTERA_RIESGO_C_PRODUCTIVO',
                    'CARTERA_NDI_C_PRODUCTIVO',
                    'CARTERA_VENCIDA_C_PRODUCTIVO'
                ], false)}

                <div class="section-title">üèõÔ∏è CARTERA INVERSI√ìN P√öBLICA</div>
                ${createTable('inv-publica', [
                    'Total Cartera de Cr√©dito Inversi√≥n Publica',
                    'Total Provisiones Espec√≠ficas Inversi√≥n Publica',
                    'Total Provisi√≥n Gen√©rica Inversi√≥n Publica',
                    'Cartera por Vencer Inversi√≥n Publica',
                    'Total Cartera Riesgo Inversi√≥n Publica',
                    'Cartera NDI Inversi√≥n Publica',
                    'Cartera Vencida Inversi√≥n Publica'
                ], fechas, results, [
                    'TOTAL_C_DE_CREDITO_C_IN_PUBLICO',
                    'TOTAL_PROVISIONES_ESPECIFICAS_C_IN_PUBLICO',
                    'TOTAL_PROVISI√ìN_GEN√âRICA_CREDITO_C_IN_PUBLICO',
                    'CARTERA_X_VENCER_C_IN_PUBLICO',
                    'TOTAL_CARTERA_RIESGO_C_IN_PUBLICO',
                    'CARTERA_NDI_IN_PUBLICO',
                    'CARTERA_VENCIDA_IN_PUBLICO'
                ], false)}

                <div class="section-title">üìà INDICADORES PRODUCTIVO</div>
                ${createTable('indicadores-prod', [
                    'CARTERA PRODUCTIVO',
                    'PORCENTAJE DE CARTERA POR VENCER',
                    'PORCENTAJE DE CARTERA EN RIESGO',
                    'PORCENTAJE DE CARTERA QUE NO DEVENGA INTERES',
                    'PORCENTAJE DE CARTERA VENCIDA'
                ], fechas, results, [
                    'PORCENTAJE_CARTERA_X_VENCER_PROD',
                    'PORCENTAJE_CARTERA_X_VENCER_PROD',
                    'PORCENTAJE_CARTERA_RIESGO_PROD',
                    'PORCENTA_CARTERA_NDI_PROD',
                    'PORCENTAJE_CARTERA_VENCIDA_PROD'
                ], true)}

                <div class="section-title">üìâ INDICADORES INVERSI√ìN P√öBLICA</div>
                ${createTable('indicadores-inv', [
                    'CARTERA INVERSI√ìN P√öBLICA',
                    'PORCENTAJE DE CARTERA POR VENCER',
                    'PORCENTAJE DE CARTERA EN RIESGO',
                    'PORCENTA DE CARTERA QUE NO DEVENGA INTERES',
                    'PORCENTAJE DE CARTERA VENCIDA'
                ], fechas, results, [
                    'CARTERA_INVERSI√ìN_P√öBLICA',
                    'PORCENTAJE_CARTERA_X_VENCER_IN_PUBLICO',
                    'PORCENTAJE_CARTERA_RIESGO_IN_PUBLICO',
                    'PORCENTA_CARTERA_NDI_IN_PUBLICO',
                    'PORCENTAJE_CARTERA_VENCIDA_IN_PUBLICO'
                ], true)}

                <div class="section-title">üíº PROVISIONES</div>
                ${createTable('provisiones', [
                    'Productivo',
                    'Inversi√≥n Publica',
                    'Refinanciada',
                    'Reestructurada',
                    'Provisi√≥n Antic√≠clica',
                    'Provisiones no reversadas por requerimiento normativo',
                    'Provisi√≥n gen√©rica voluntaria',
                    'Provisiones para cr√©ditos incobrables'
                ], fechas, results, [
                    'Prov_Productivo',
                    'Prov_Inv_Publica',
                    'Prov_Refinanciada',
                    'Prov_Reestructurada',
                    'Prov_Anticiclica',
                    'Prov_No_Normativo',
                    'Prov_Voluntaria',
                    'Prov_Incombrables'
                ], false)}
            `;
        }

        function createTable(cssClass, concepts, fechas, results, fields, isPercentage) {
            let html = `<div class="table-container">
                <table class="${cssClass}">
                    <thead>
                        <tr>
                            <th>Concepto</th>`;
            
            fechas.forEach(fecha => {
                html += `<th>${fecha}</th>`;
            });
            
            html += `</tr></thead><tbody>`;

            concepts.forEach((concept, index) => {
                html += `<tr><td class="concept-column">${concept}</td>`;
                
                fechas.forEach(fecha => {
                    const value = results[fecha][fields[index]];
                    const formattedValue = isPercentage ? 
                        formatPercentage(value) : 
                        formatCurrency(value);
                    html += `<td class="number-column">${formattedValue}</td>`;
                });
                
                html += `</tr>`;
            });

            html += `</tbody></table></div>`;
            return html;
        }

        function formatCurrency(value) {
            if (value === null || value === undefined || isNaN(value)) return '$0.00';
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        function formatPercentage(value) {
            if (value === null || value === undefined || isNaN(value)) return '0.00%';
            return new Intl.NumberFormat('en-US', {
                style: 'percent',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value / 100);
        }

        function downloadExcel() {
            if (!processedResults) {
                showError('No hay datos para descargar');
                return;
            }

            try {
                // Crear workbook
                const wb = XLSX.utils.book_new();
                const fechas = Object.keys(processedResults).sort();

                // Crear datos integrados
                const integratedData = [];

                // Secci√≥n Coberturas
                integratedData.push(['SECCI√ìN', 'CONCEPTO', ...fechas]);
                integratedData.push(['üìä COBERTURAS', '', '','','']);
                integratedData.push(['', 'COBERTURA CARTERA PRODUCTIVO (%)', ...fechas.map(f => processedResults[f].Porcentaje_Cartera_productivo)]);
                integratedData.push(['', 'COBERTURA CARTERA INVERSI√ìN P√öBLICA (%)', ...fechas.map(f => processedResults[f].Porcentaje_Cartera_Inv_Publico)]);
                integratedData.push(['', 'COBERTURA TOTAL CARTERA (%)', ...fechas.map(f => processedResults[f].COBERTURA_TOTAL_CARTERA)]);
                integratedData.push(['', '', '','','']); // Separador

                // Secci√≥n Cartera Productivo
                integratedData.push(['üí∞ CARTERA PRODUCTIVO', '', '','','']);
                integratedData.push(['', 'Total Cartera de Cr√©dito Productivo', ...fechas.map(f => processedResults[f].TOTAL_C_CREDITO_PRODUCTIVO)]);
                integratedData.push(['', 'Total Provisiones Espec√≠ficas C. Productivo', ...fechas.map(f => processedResults[f].TOTAL_PROVISIONES_ESPECIFICAS_C_PRODUCTIVO)]);
                integratedData.push(['', 'Total Provisi√≥n Gen√©rica C. Productivo', ...fechas.map(f => processedResults[f].TOTAL_PROVISI√ìN_GEN√âRICA_C_PRODUCTIVO)]);
                integratedData.push(['', 'Cartera por Vencer C. Productivo', ...fechas.map(f => processedResults[f].CARTERA_X_VENCER_C_PRODUCTIVO)]);
                integratedData.push(['', 'Total Cartera Riesgo C. Productivo', ...fechas.map(f => processedResults[f].TOTAL_CARTERA_RIESGO_C_PRODUCTIVO)]);
                integratedData.push(['', 'Cartera NDI C. Productivo', ...fechas.map(f => processedResults[f].CARTERA_NDI_C_PRODUCTIVO)]);
                integratedData.push(['', 'Cartera Vencida C. Productivo', ...fechas.map(f => processedResults[f].CARTERA_VENCIDA_C_PRODUCTIVO)]);
                integratedData.push(['', '', '','','']); // Separador

                // Secci√≥n Cartera Inversi√≥n P√∫blica
                integratedData.push(['üèõÔ∏è CARTERA INVERSI√ìN P√öBLICA', '', '','','']);
                integratedData.push(['', 'Total Cartera de Cr√©dito Inversi√≥n Publica', ...fechas.map(f => processedResults[f].TOTAL_C_DE_CREDITO_C_IN_PUBLICO)]);
                integratedData.push(['', 'Total Provisiones Espec√≠ficas Inversi√≥n Publica', ...fechas.map(f => processedResults[f].TOTAL_PROVISIONES_ESPECIFICAS_C_IN_PUBLICO)]);
                integratedData.push(['', 'Total Provisi√≥n Gen√©rica Inversi√≥n Publica', ...fechas.map(f => processedResults[f].TOTAL_PROVISI√ìN_GEN√âRICA_CREDITO_C_IN_PUBLICO)]);
                integratedData.push(['', 'Cartera por Vencer Inversi√≥n Publica', ...fechas.map(f => processedResults[f].CARTERA_X_VENCER_C_IN_PUBLICO)]);
                integratedData.push(['', 'Total Cartera Riesgo Inversi√≥n Publica', ...fechas.map(f => processedResults[f].TOTAL_CARTERA_RIESGO_C_IN_PUBLICO)]);
                integratedData.push(['', 'Cartera NDI Inversi√≥n Publica', ...fechas.map(f => processedResults[f].CARTERA_NDI_IN_PUBLICO)]);
                integratedData.push(['', 'Cartera Vencida Inversi√≥n Publica', ...fechas.map(f => processedResults[f].CARTERA_VENCIDA_IN_PUBLICO)]);
                integratedData.push(['', '', '','','']); // Separador

                // Secci√≥n Indicadores Productivo
                integratedData.push(['üìà INDICADORES PRODUCTIVO', '', '','','']);
                integratedData.push(['', 'CARTERA PRODUCTIVO', ...fechas.map(f => processedResults[f].PORCENTAJE_CARTERA_X_VENCER_PROD)]);
                integratedData.push(['', 'PORCENTAJE DE CARTERA POR VENCER', ...fechas.map(f => processedResults[f].PORCENTAJE_CARTERA_X_VENCER_PROD)]);
                integratedData.push(['', 'PORCENTAJE DE CARTERA EN RIESGO', ...fechas.map(f => processedResults[f].PORCENTAJE_CARTERA_RIESGO_PROD)]);
                integratedData.push(['', 'PORCENTAJE DE CARTERA QUE NO DEVENGA INTERES', ...fechas.map(f => processedResults[f].PORCENTA_CARTERA_NDI_PROD)]);
                integratedData.push(['', 'PORCENTAJE DE CARTERA VENCIDA', ...fechas.map(f => processedResults[f].PORCENTAJE_CARTERA_VENCIDA_PROD)]);
                integratedData.push(['', '', '','','']); // Separador

                // Secci√≥n Indicadores Inversi√≥n P√∫blica
                integratedData.push(['üìâ INDICADORES INVERSI√ìN P√öBLICA', '', '','','']);
                integratedData.push(['', 'CARTERA INVERSI√ìN P√öBLICA', ...fechas.map(f => processedResults[f].CARTERA_INVERSI√ìN_P√öBLICA)]);
                integratedData.push(['', 'PORCENTAJE DE CARTERA POR VENCER', ...fechas.map(f => processedResults[f].PORCENTAJE_CARTERA_X_VENCER_IN_PUBLICO)]);
                integratedData.push(['', 'PORCENTAJE DE CARTERA EN RIESGO', ...fechas.map(f => processedResults[f].PORCENTAJE_CARTERA_RIESGO_IN_PUBLICO)]);
                integratedData.push(['', 'PORCENTA DE CARTERA QUE NO DEVENGA INTERES', ...fechas.map(f => processedResults[f].PORCENTA_CARTERA_NDI_IN_PUBLICO)]);
                integratedData.push(['', 'PORCENTAJE DE CARTERA VENCIDA', ...fechas.map(f => processedResults[f].PORCENTAJE_CARTERA_VENCIDA_IN_PUBLICO)]);
                integratedData.push(['', '', '','','']); // Separador

                // Secci√≥n Provisiones
                integratedData.push(['üíº PROVISIONES', '', '','','']);
                integratedData.push(['', 'Productivo', ...fechas.map(f => processedResults[f].Prov_Productivo)]);
                integratedData.push(['', 'Inversi√≥n Publica', ...fechas.map(f => processedResults[f].Prov_Inv_Publica)]);
                integratedData.push(['', 'Refinanciada', ...fechas.map(f => processedResults[f].Prov_Refinanciada)]);
                integratedData.push(['', 'Reestructurada', ...fechas.map(f => processedResults[f].Prov_Reestructurada)]);
                integratedData.push(['', 'Provisi√≥n Antic√≠clica', ...fechas.map(f => processedResults[f].Prov_Anticiclica)]);
                integratedData.push(['', 'Provisiones no reversadas por requerimiento normativo', ...fechas.map(f => processedResults[f].Prov_No_Normativo)]);
                integratedData.push(['', 'Provisi√≥n gen√©rica voluntaria', ...fechas.map(f => processedResults[f].Prov_Voluntaria)]);
                integratedData.push(['', 'Provisiones para cr√©ditos incobrables', ...fechas.map(f => processedResults[f].Prov_Incombrables)]);

                // Crear worksheet
                const ws = XLSX.utils.aoa_to_sheet(integratedData);
                
                // Aplicar formato a las columnas de n√∫meros (C:E)
                const range = XLSX.utils.decode_range(ws['!ref']);
                for (let row = 0; row <= range.e.r; row++) {
                    for (let col = 2; col <= range.e.c; col++) {
                        const cellAddr = XLSX.utils.encode_cell({ r: row, c: col });
                        if (ws[cellAddr] && typeof ws[cellAddr].v === 'number') {
                            ws[cellAddr].z = '#,##0.00';
                        }
                    }
                }

                // Ajustar anchos de columnas
                ws['!cols'] = [
                    { wch: 40 }, // Secci√≥n
                    { wch: 50 }, // Concepto
                    { wch: 20 }, // Fecha 1
                    { wch: 20 }, // Fecha 2
                    { wch: 20 }  // Fecha 3
                ];

                XLSX.utils.book_append_sheet(wb, ws, "Reporte_Consolidado_Trimestral");

                // Generar archivo
                const fileName = `Reporte_BDD_Trimestral_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showSuccess(`Archivo Excel descargado: ${fileName}`);

            } catch (error) {
                showError('Error al generar el archivo Excel: ' + error.message);
                console.error('Error:', error);
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMsg');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMsg');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 5000);
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // Cargar datos por defecto al iniciar
        window.addEventListener('load', () => {
            console.log('P√°gina cargada - Lista para procesar archivos Excel');
        });
    </script>
</body>
</html>
