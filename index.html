<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indicadores de Cartera de Cr√©dito - BDE</title>
    
    <!-- Cargar XLSX PRIMERO antes que todo -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 15px;
            padding: 8px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .tab {
            flex: 1;
            padding: 15px 25px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .tab:hover:not(.active) {
            background: #f8f9fa;
            transform: translateY(-1px);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-display {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            border: 2px dashed #667eea;
            border-radius: 12px;
            background: #f8f9ff;
            transition: all 0.3s ease;
            min-height: 60px;
        }

        .file-input-display:hover {
            border-color: #764ba2;
            background: #f0f4ff;
            transform: scale(1.02);
        }

        .file-icon {
            font-size: 24px;
            color: #667eea;
        }

        .file-text {
            flex: 1;
            color: #666;
        }

        .file-text.has-file {
            color: #2c3e50;
            font-weight: 600;
        }

        select, input[type="radio"] {
            margin-right: 8px;
        }

        select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 16px;
            background: white;
            transition: border-color 0.3s ease;
        }

        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .radio-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .radio-option.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .radio-option input[type="radio"] {
            margin-right: 12px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status-box {
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin: 20px 0;
            border: 2px solid;
        }

        .status-success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .status-warning {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-value {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .table-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .table-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .table-scroll {
            max-height: 600px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e1e8ed;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background: #f8f9ff;
        }

        .section-header {
            background: #f39c12 !important;
            color: white !important;
            font-weight: 700;
        }

        .section-header.inversion {
            background: #27ae60 !important;
        }

        .section-header.total {
            background: #e74c3c !important;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .export-btn {
            background: #27ae60;
            margin-bottom: 15px;
            width: auto;
            padding: 10px 20px;
            font-size: 14px;
        }

        .export-btn:hover {
            background: #2ecc71;
        }

        @media (max-width: 768px) {
            .control-grid {
                grid-template-columns: 1fr;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¶ Indicadores de Cartera de Cr√©dito - BDE</h1>
            <p>Sistema de An√°lisis de Cobertura de Provisiones y Calidad de Cartera</p>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('cargar')">
                üìÅ Cargar Datos
            </div>
            <div class="tab" onclick="switchTab('indicadores')">
                üìä Indicadores 2.3.3.2 y 2.3.3.3
            </div>
        </div>

        <!-- Tab 1: Cargar Datos -->
        <div id="cargar" class="tab-content active">
            <div class="control-grid">
                <div class="card">
                    <h3>üìÅ Cargar Archivo Excel</h3>
                    <div class="form-group">
                        <label>Seleccionar archivo Excel:</label>
                        <div class="file-input-wrapper">
                            <input type="file" class="file-input" id="archivo_excel" accept=".xlsx,.xls">
                            <div class="file-input-display">
                                <div class="file-icon">üìÑ</div>
                                <div class="file-text" id="file-text">Arrastra tu archivo aqu√≠ o haz clic para seleccionar</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>üìä Tipo de An√°lisis</h3>
                    <div class="form-group">
                        <label>Seleccionar periodicidad:</label>
                        <div class="radio-group">
                            <div class="radio-option selected" onclick="selectRadio('mensual')">
                                <input type="radio" name="tipo_analisis" value="mensual" checked>
                                üìÖ Mensual
                            </div>
                            <div class="radio-option" onclick="selectRadio('trimestral')">
                                <input type="radio" name="tipo_analisis" value="trimestral">
                                üìà Trimestral
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>üìÖ Fecha de An√°lisis</h3>
                    <div class="form-group">
                        <label for="fecha_seleccionada">Fecha disponible:</label>
                        <select id="fecha_seleccionada" disabled>
                            <option>Carga un archivo primero</option>
                        </select>
                    </div>
                    <button class="btn" id="procesar_datos" onclick="procesarDatos()" disabled>
                        üîÑ Procesar An√°lisis
                    </button>
                </div>
            </div>

            <div class="card">
                <h3>üìä Estado del Sistema</h3>
                <div id="estado_carga">
                    <div class="status-box status-error">
                        <h4>üìÅ Sin datos cargados</h4>
                        <p>Selecciona un archivo Excel para comenzar el an√°lisis.</p>
                    </div>
                </div>
                
                <div id="info_dataset" style="display: none;">
                    <h4>üìä Informaci√≥n del Dataset:</h4>
                    <div id="dataset_info"></div>
                    
                    <h4>üìã Vista Previa de Datos:</h4>
                    <div class="table-container">
                        <div class="table-scroll">
                            <table id="preview_table">
                                <thead></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 2: Indicadores -->
        <div id="indicadores" class="tab-content">
            <div class="card">
                <div class="table-header">
                    <h3>INDICADORES DE CARTERA DE CR√âDITO - BDE</h3>
                    <h4>2.3.3.2 COBERTURA DE PROVISIONES POR SEGMENTO</h4>
                    <h4>2.3.3.3 CALIDAD DE CARTERA POR SEGMENTOS DE CR√âDITO</h4>
                    <h4 id="fecha_indicadores">üìÖ Per√≠odo de an√°lisis: No disponible</h4>
                </div>
            </div>

            <div class="metrics-grid" id="metrics_container" style="display: none;">
                <div class="metric-card">
                    <div class="metric-value" id="total_productivo">$0M</div>
                    <div class="metric-label">Cartera Productivo</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="total_inversion">$0M</div>
                    <div class="metric-label">Cartera Inv. P√∫blica</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="cobertura_total">0%</div>
                    <div class="metric-label">Cobertura Total</div>
                </div>
            </div>

            <div class="card">
                <div id="no_data_message">
                    <div class="status-box status-error">
                        <h4>‚ö†Ô∏è Datos no disponibles</h4>
                        <p>Por favor, carga un archivo Excel y procesa los datos en la pesta√±a 'Cargar Datos'.</p>
                    </div>
                </div>

                <div id="tabla_indicadores_container" style="display: none;">
                    <button class="btn export-btn" onclick="exportarExcel()">
                        üìä Exportar a Excel
                    </button>
                    <div class="table-container">
                        <div class="table-scroll">
                            <table id="tabla_indicadores">
                                <thead></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Procesando datos...</p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Global variables
        let datosOriginales = null;
        let fechasDisponibles = [];
        let fechasTrimestrales = [];
        let analisisCompleto = null;

        // Tab switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
        }

        // Radio button selection
        function selectRadio(value) {
            document.querySelectorAll('.radio-option').forEach(option => option.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            
            document.querySelectorAll('input[name="tipo_analisis"]').forEach(input => {
                input.checked = input.value === value;
            });
            
            updateFechaSelector();
        }

        // File input handling
        document.getElementById('archivo_excel').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const fileText = document.getElementById('file-text');
            
            if (file) {
                fileText.textContent = file.name;
                fileText.classList.add('has-file');
                cargarArchivo(file);
            } else {
                fileText.textContent = 'Arrastra tu archivo aqu√≠ o haz clic para seleccionar';
                fileText.classList.remove('has-file');
            }
        });

        // Generate dates function (mimicking R code)
        function generarFechas(numColumnas) {
            const fechas = [];
            let year = 2003;
            let month = 1;
            
            for (let i = 0; i < numColumnas; i++) {
                let day;
                if (month === 2) {
                    day = ((year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0)) ? 29 : 28;
                } else if ([4, 6, 9, 11].includes(month)) {
                    day = 30;
                } else {
                    day = 31;
                }
                
                const fechaStr = `${day.toString().padStart(2, '0')}/${month.toString().padStart(2, '0')}/${year}`;
                fechas.push(fechaStr);
                
                month++;
                if (month > 12) {
                    month = 1;
                    year++;
                }
            }
            
            return fechas;
        }

        // Generate quarterly dates
        function generarFechasTrimestrales(fechasMensuales) {
            const fechasTrimestrales = [];
            const etiquetas = [];
            
            fechasMensuales.forEach(fecha => {
                const [dia, mes, a√±o] = fecha.split('/').map(Number);
                
                // Q1: Marzo (31/03), Q2: Junio (30/06), Q3: Septiembre (30/09), Q4: Diciembre (31/12)
                if (mes === 3 || mes === 6 || mes === 9 || mes === 12) {
                    const trimestre = mes === 3 ? 'Q1' : mes === 6 ? 'Q2' : mes === 9 ? 'Q3' : 'Q4';
                    fechasTrimestrales.push(fecha);
                    etiquetas.push(`${trimestre} ${a√±o} (${fecha})`);
                }
            });
            
            return { fechas: fechasTrimestrales, etiquetas };
        }

        // Funci√≥n para cargar datos desde GitHub
        async function cargarDatosIniciales() {
            try {
                showLoading(true);
                console.log('üîÑ Cargando datos iniciales desde GitHub...');
                
                // URL del archivo en GitHub (raw)
                const githubUrl = 'https://raw.githubusercontent.com/Christiti99-crypto/bde-credit-dashboard/main/BDD/BANCO%20DE%20DESARROLLO%20DEL%20ECUADOR%20B.P.%202025_06.xlsx';
                
                // Descargar archivo desde GitHub
                const response = await fetch(githubUrl);
                if (!response.ok) {
                    throw new Error(`Error al descargar archivo: ${response.status} ${response.statusText}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                
                // Procesar archivo Excel usando la misma l√≥gica
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                
                console.log('üìä Procesando datos iniciales desde GitHub...');
                console.log('Rango detectado:', worksheet['!ref']);
                
                // Leer datos desde A5 (misma l√≥gica que cargarArchivo)
                const fullData = XLSX.utils.sheet_to_json(worksheet, { 
                    header: 1,
                    defval: null,
                    range: 4
                });
                
                if (!fullData[0] || fullData[0].length < 5) {
                    throw new Error('El archivo inicial no tiene el formato esperado');
                }
                
                // Procesar datos con la misma l√≥gica
                const current_names = fullData[0];
                const numeric_columns_start = 2;
                const numeric_columns_end = current_names.length - 2;
                const numeric_columns_count = numeric_columns_end - numeric_columns_start;
                
                const fechasGeneradas = generarFechas(numeric_columns_count);
                const all_new_names = ['CODIGO', 'CUENTA', ...fechasGeneradas, 'VAR_ABSOLUTA', 'VAR_RELATIVA'];
                
                // Ajustar columnas si es necesario
                if (all_new_names.length < current_names.length) {
                    const extras_needed = current_names.length - all_new_names.length;
                    for (let i = 0; i < extras_needed; i++) {
                        all_new_names.splice(-2, 0, `EXTRA_COL_${i + 1}`);
                    }
                }
                
                // Estructurar datos
                const datosEstructurados = fullData.slice(1).map((row, index) => {
                    const objeto = {};
                    all_new_names.forEach((header, columnIndex) => {
                        if (header === 'CODIGO') {
                            objeto[header] = parseInt(row[columnIndex]) || 0;
                        } else if (header === 'CUENTA') {
                            objeto[header] = row[columnIndex] || '';
                        } else if (header.includes('/')) {
                            objeto[header] = parseFloat(row[columnIndex]) || 0;
                        } else {
                            objeto[header] = parseFloat(row[columnIndex]) || 0;
                        }
                    });
                    return objeto;
                }).filter(row => row.CODIGO > 0 && row.CUENTA);
                
                // Guardar datos iniciales
                datosOriginales = datosEstructurados;
                fechasDisponibles = fechasGeneradas;
                fechasTrimestrales = generarFechasTrimestrales(fechasGeneradas);
                
                console.log('‚úÖ Datos iniciales cargados exitosamente');
                console.log('üìä Filas:', datosEstructurados.length);
                console.log('üìÖ Per√≠odos:', fechasGeneradas.length);
                console.log('üóìÔ∏è Desde:', fechasGeneradas[0], 'hasta:', fechasGeneradas[fechasGeneradas.length - 1]);
                
                // Actualizar UI con estado inicial
                updateEstadoCargaInicial();
                updateFechaSelector();
                updateDatasetInfo(fechasGeneradas.length);
                
                // Habilitar controles
                document.getElementById('fecha_seleccionada').disabled = false;
                document.getElementById('procesar_datos').disabled = false;
                
                // **PROCESAR AUTOM√ÅTICAMENTE CON LA √öLTIMA FECHA DISPONIBLE**
                document.getElementById('fecha_seleccionada').value = fechasDisponibles[fechasDisponibles.length - 1];
                await procesarDatos();
                
                // **CAMBIAR AUTOM√ÅTICAMENTE A LA PESTA√ëA DE INDICADORES**
                setTimeout(() => {
                    switchTab('indicadores');
                    // Actualizar visualmente las pesta√±as
                    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                    document.querySelectorAll('.tab')[1].classList.add('active'); // Segunda pesta√±a (indicadores)
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    document.getElementById('indicadores').classList.add('active');
                }, 500);
                
                showNotification('‚úÖ Datos iniciales cargados desde GitHub y procesados autom√°ticamente', 'success');
                
            } catch (error) {
                console.error('‚ùå Error al cargar datos iniciales:', error);
                
                // Mostrar estado de error pero no bloquear la aplicaci√≥n
                updateEstadoCargaError();
                showNotification(`‚ö†Ô∏è No se pudieron cargar los datos iniciales desde GitHub. Puedes cargar tu propio archivo.`, 'warning');
            } finally {
                showLoading(false);
            }
        }

        // Actualizar estado de carga inicial exitosa
        function updateEstadoCargaInicial() {
            const container = document.getElementById('estado_carga');
            
            container.innerHTML = `
                <div class="status-box status-success">
                    <h4>‚úÖ Datos iniciales cargados desde GitHub</h4>
                    <p>Archivo: BANCO DE DESARROLLO DEL ECUADOR B.P. 2025_06.xlsx</p>
                    <p>Fechas disponibles: ${fechasDisponibles.length} per√≠odos</p>
                    <p>Per√≠odo: ${fechasDisponibles[0]} hasta ${fechasDisponibles[fechasDisponibles.length - 1]}</p>
                    <p><strong>üí° Tip:</strong> Puedes subir un nuevo archivo para reemplazar estos datos</p>
                </div>
            `;
            document.getElementById('info_dataset').style.display = 'block';
        }

        // Actualizar estado de error en carga inicial
        function updateEstadoCargaError() {
            const container = document.getElementById('estado_carga');
            
            container.innerHTML = `
                <div class="status-box status-warning">
                    <h4>‚ö†Ô∏è Datos iniciales no disponibles</h4>
                    <p>No se pudo acceder al archivo inicial desde GitHub.</p>
                    <p>Por favor, carga tu archivo Excel manualmente.</p>
                </div>
            `;
        }

        // Funci√≥n para leer y procesar archivo Excel real (AUTO-DETECCI√ìN)
        async function cargarArchivo(file) {
            try {
                showLoading(true);
                
                const tienesDatosIniciales = datosOriginales && datosOriginales.length > 0;
                if (tienesDatosIniciales) {
                    console.log('üîÑ REEMPLAZANDO datos iniciales con nuevo archivo...');
                } else {
                    console.log('üìÅ CARGANDO primer archivo...');
                }
                
                // Leer archivo Excel usando SheetJS
                const buffer = await file.arrayBuffer();
                const workbook = XLSX.read(buffer, { type: 'array' });
                
                // Obtener la primera hoja
